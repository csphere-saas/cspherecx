{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "NPS Dashboard" %}{% endblock %}

{% block content %}
<section class="py-3"><p>&nbsp;</p></section>
<div class="container-fluid">
    <!-- Header with filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-chart-bar me-2"></i>{% trans "NPS Performance Dashboard" %}
                            <small class="text-muted ms-2">- {{ organization.name }}</small>
                        </h4>
                        <div class="btn-group">
                            <a href="?days=30" class="btn btn-outline-primary {% if days_filter == 30 %}active{% endif %}">
                                {% trans "30 Days" %}
                            </a>
                            <a href="?days=90" class="btn btn-outline-primary {% if days_filter == 90 %}active{% endif %}">
                                {% trans "90 Days" %}
                            </a>
                            <a href="?days=180" class="btn btn-outline-primary {% if days_filter == 180 %}active{% endif %}">
                                {% trans "180 Days" %}
                            </a>
                            <a href="?days=365" class="btn btn-outline-primary {% if days_filter == 365 %}active{% endif %}">
                                {% trans "1 Year" %}
                            </a>
                        </div>
                    </div>
                    <p class="text-muted mt-2">
                        <i class="fas fa-calendar me-1"></i>
                        {% blocktrans with start=start_date|date:"M d, Y" end=end_date|date:"M d, Y" %}
                        Showing data from {{ start }} to {{ end }}
                        {% endblocktrans %}
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- KPI Cards -->
    <div class="row">
        <!-- NPS Score -->
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted">{% trans "NPS Score" %}</h6>
                    <div class="stat-value nps-score 
                        {% if nps_score > 50 %}nps-excellent
                        {% elif nps_score > 30 %}nps-good
                        {% elif nps_score > 0 %}nps-fair
                        {% else %}nps-poor{% endif %}">
                        {{ nps_score }}
                    </div>
                    <div class="d-flex justify-content-between mt-3">
                        <small class="text-success">
                            <i class="fas fa-arrow-up me-1"></i>{{ promoter_count }} {% trans "Promoters" %}
                        </small>
                        <small class="text-danger">
                            <i class="fas fa-arrow-down me-1"></i>{{ detractor_count }} {% trans "Detractors" %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Average Score -->
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted">{% trans "Average Score" %}</h6>
                    <div class="stat-value text-primary">{{ avg_score|floatformat:1 }}</div>
                    <p class="text-muted mb-0">{% trans "Out of 10" %}</p>
                </div>
            </div>
        </div>
        
        <!-- Total Responses -->
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted">{% trans "Total Responses" %}</h6>
                    <div class="stat-value text-info">{{ total_responses }}</div>
                    <p class="text-muted mb-0">
                        {% trans "Last" %} {{ days_filter }} {% trans "days" %}
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Trend -->
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted">{% trans "30-Day Trend" %}</h6>
                    <div class="stat-value {% if trend_30_days.trend > 0 %}text-success{% elif trend_30_days.trend < 0 %}text-danger{% else %}text-muted{% endif %}">
                        {{ trend_30_days.trend }}%
                    </div>
                    <p class="text-muted mb-0">
                        {% if trend_30_days.direction == 'up' %}
                            <i class="fas fa-arrow-up text-success me-1"></i>{% trans "Improving" %}
                        {% elif trend_30_days.direction == 'down' %}
                            <i class="fas fa-arrow-down text-danger me-1"></i>{% trans "Declining" %}
                        {% else %}
                            <i class="fas fa-minus text-muted me-1"></i>{% trans "Stable" %}
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Row 1 -->
    <div class="row">
        <!-- Score Distribution -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>{% trans "Score Distribution" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="scoreDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Category Breakdown -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>{% trans "Category Breakdown" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Row 2 -->
    <div class="row">
        <!-- Time Series -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>{% trans "NPS Trend Over Time" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="timeSeriesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sentiment Analysis -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-smile me-2"></i>{% trans "Sentiment Analysis" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="sentimentChart"></canvas>
                    </div>
                    <div class="text-center mt-3">
                        <span class="badge bg-success me-2">
                            {% trans "Positive" %}: {{ sentiment_data.positive|default:0 }}
                        </span>
                        <span class="badge bg-warning me-2">
                            {% trans "Neutral" %}: {{ sentiment_data.neutral|default:0 }}
                        </span>
                        <span class="badge bg-danger">
                            {% trans "Negative" %}: {{ sentiment_data.negative|default:0 }}
                        </span>
                    </div>
                    {% if sentiment_data.analysis_rate %}
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            {% trans "Analysis Rate" %}: {{ sentiment_data.analysis_rate }}%
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Product Performance -->
    {% if product_performance %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cube me-2"></i>{% trans "Product Performance" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>{% trans "Product" %}</th>
                                    <th>{% trans "Avg Score" %}</th>
                                    <th>{% trans "NPS" %}</th>
                                    <th>{% trans "Responses" %}</th>
                                    <th>{% trans "Performance" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in product_performance %}
                                <tr>
                                    <td>{{ product.product__name|default:"N/A" }}</td>
                                    <td>
                                        <span class="badge bg-primary">{{ product.avg_score|floatformat:1 }}</span>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if product.nps_score > 50 %}bg-success
                                            {% elif product.nps_score > 30 %}bg-info
                                            {% elif product.nps_score > 0 %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ product.nps_score|floatformat:1 }}
                                        </span>
                                    </td>
                                    <td>{{ product.response_count }}</td>
                                    <td>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar 
                                                {% if product.avg_score >= 9 %}bg-success
                                                {% elif product.avg_score >= 7 %}bg-warning
                                                {% else %}bg-danger{% endif %}" 
                                                style="width: {{ product.avg_score|floatformat:0 }}0%">
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        {% trans "No product performance data available" %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Recent Responses & Top Themes -->
    <div class="row">
        <!-- Recent Responses -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-history me-2"></i>{% trans "Recent Responses" %}
                        </h5>
                        <a href="{% url 'surveys:nps-response-list' organization_id=organization_id %}" class="btn btn-sm btn-outline-primary">
                            {% trans "View All" %} <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>{% trans "Customer" %}</th>
                                    <th>{% trans "Score" %}</th>
                                    <th>{% trans "Category" %}</th>
                                    <th>{% trans "Reason" %}</th>
                                    <th>{% trans "Date" %}</th>
                                    <th>{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for response in recent_responses %}
                                <tr>
                                    <td>
                                        {% if response.customer %}
                                        <a href="#" class="text-decoration-none" title="{{ response.customer.email }}">
                                            {{ response.customer.email|truncatechars:20 }}
                                        </a>
                                        {% else %}
                                        <span class="text-muted">{% trans "No Customer" %}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="score-badge score-{{ response.score }}">
                                            {{ response.score }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="category-tag {{ response.category }}-tag">
                                            {{ response.get_category_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ response.reason|truncatechars:40|default:"-" }}</small>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ response.created_at|date:"M d" }}</small>
                                    </td>
                                    <td>
                                        <a href="{% url 'surveys:nps-response-detail' organization_id=organization_id pk=response.pk %}" 
                                           class="btn btn-sm btn-outline-info" title="{% trans 'View Details' %}">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-3"></i><br>
                                        {% trans "No recent responses" %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top Themes -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tags me-2"></i>{% trans "Top Themes" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if themes_data %}
                    <div class="list-group list-group-flush">
                        {% for theme_item in themes_data %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ theme_item.theme }}</span>
                            <span class="badge bg-primary rounded-pill">{{ theme_item.count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-3">
                        {% trans "No theme data available" %}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Quick Links -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-link me-2"></i>{% trans "Quick Links" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'surveys:nps-response-list' organization_id=organization_id %}" class="btn btn-outline-primary">
                            <i class="fas fa-list me-2"></i>{% trans "All NPS Responses" %}
                        </a>
                        <a href="{% url 'surveys:nps-dashboard-api' organization_id=organization_id %}" class="btn btn-outline-info" target="_blank">
                            <i class="fas fa-code me-2"></i>{% trans "Dashboard API" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Score Distribution Chart
    const scoreCtx = document.getElementById('scoreDistributionChart').getContext('2d');
    const scoreDistributionChart = new Chart(scoreCtx, {
        type: 'bar',
        data: {
            labels: Object.keys({{ score_data|safe }}),
            datasets: [{
                label: '{% trans "Number of Responses" %}',
                data: Object.values({{ score_data|safe }}),
                backgroundColor: [
                    '#ef476f', '#ef476f', '#ef476f', '#ef476f', '#ef476f', '#ef476f',
                    '#ffd166', '#ffd166',
                    '#06d6a0', '#06d6a0', '#06d6a0'
                ],
                borderColor: [
                    '#d13b5d', '#d13b5d', '#d13b5d', '#d13b5d', '#d13b5d', '#d13b5d',
                    '#e6b95c', '#e6b95c',
                    '#06b48a', '#06b48a', '#06b48a'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '{% trans "Number of Responses" %}'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '{% trans "NPS Score (0-10)" %}'
                    }
                }
            }
        }
    });
    
    // Category Breakdown Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: ['{% trans "Promoter" %}', '{% trans "Passive" %}', '{% trans "Detractor" %}'],
            datasets: [{
                data: [
                    {{ promoter_count }},
                    {{ passive_count }},
                    {{ detractor_count }}
                ],
                backgroundColor: [
                    '#06d6a0',
                    '#ffd166',
                    '#ef476f'
                ],
                borderColor: [
                    '#06b48a',
                    '#e6b95c',
                    '#d13b5d'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    });
    
    // Time Series Chart
    const timeCtx = document.getElementById('timeSeriesChart').getContext('2d');
    const timeSeriesData = {{ time_series_data|safe }};
    const timeSeriesChart = new Chart(timeCtx, {
        type: 'line',
        data: {
            labels: timeSeriesData.map(item => item.date),
            datasets: [
                {
                    label: '{% trans "NPS Score" %}',
                    data: timeSeriesData.map(item => item.nps),
                    borderColor: '#4361ee',
                    backgroundColor: 'rgba(67, 97, 238, 0.1)',
                    tension: 0.3,
                    fill: true,
                    yAxisID: 'y'
                },
                {
                    label: '{% trans "Avg Score" %}',
                    data: timeSeriesData.map(item => item.avg_score),
                    borderColor: '#06d6a0',
                    backgroundColor: 'rgba(6, 214, 160, 0.1)',
                    tension: 0.3,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: '{% trans "Date" %}'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: '{% trans "NPS Score" %}'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '{% trans "Average Score" %}'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
    
    // Sentiment Chart
    const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
    const sentimentChart = new Chart(sentimentCtx, {
        type: 'pie',
        data: {
            labels: ['{% trans "Positive" %}', '{% trans "Neutral" %}', '{% trans "Negative" %}'],
            datasets: [{
                data: [
                    {{ sentiment_data.positive|default:0 }},
                    {{ sentiment_data.neutral|default:0 }},
                    {{ sentiment_data.negative|default:0 }}
                ],
                backgroundColor: [
                    '#06d6a0',
                    '#ffd166',
                    '#ef476f'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Auto-refresh data every 5 minutes
    setTimeout(function() {
        window.location.reload();
    }, 300000); // 5 minutes
    
    // Add CSS for score badges
    const style = document.createElement('style');
    style.textContent = `
        .score-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }
        
        .score-0, .score-1, .score-2, .score-3, .score-4, .score-5, .score-6 {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .score-7, .score-8 {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .score-9, .score-10 {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .category-tag {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .promoter-tag { 
            background-color: rgba(6, 214, 160, 0.2); 
            color: #06b48a; 
        }
        
        .passive-tag { 
            background-color: rgba(255, 209, 102, 0.2); 
            color: #b39136; 
        }
        
        .detractor-tag { 
            background-color: rgba(239, 71, 111, 0.2); 
            color: #d13b5d; 
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .chart-container {
                height: 250px;
            }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}
{% endblock %}